<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<title>SpoTUI</title>
<style>
:root {
  --bg:#131313;
  --fg:#eae6f7;
  --accent:#b48cff;
  --dim:#43404d;
}
body {
  margin:0;
  font-family: Open Sans, monospace;
  background:var(--bg);
  color:var(--fg);
}
header {
  padding:14px;
  border-bottom:1px solid var(--dim);
  display:flex;
  justify-content:space-between;
}
button {
  background:none;
  border:1px solid var(--accent);
  color:var(--accent);
  font-family:inherit;
  padding:6px 10px;
  cursor:pointer;
  border-radius:6px;
  transition:0.2s;
}
button:hover { background:var(--accent); color:var(--bg); }
button.active { background:var(--accent); color:var(--bg); }
main { padding:16px; }
.view { display:none; gap:16px; }
.view.active { display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); }
.panel { border:1px solid var(--dim); border-radius:8px; padding:12px; background:#1a1724; }
h2 { margin:0 0 12px; color:var(--accent); font-size:16px; }
ul { list-style:none; padding:0; margin:0; display:grid; gap:8px; }
.card { display:flex; align-items:center; background:#2a2339; border-radius:8px; padding:6px; gap:8px; transition: transform 0.2s; }
.card:hover { transform: scale(1.02); }
.card img { width:50px; height:50px; border-radius:6px; object-fit: cover; }
.title { font-weight:bold; color:var(--accent); }
.subtitle { font-size:12px; color:var(--dim); }
.genre-card { margin-bottom:8px; }
.genre-card .name { color:var(--fg); font-weight:bold; margin-bottom:2px; display:block; }
.genre-card .bar { height:10px; background:var(--accent); border-radius:5px; }
select { background:var(--bg); color:var(--accent); border:1px solid var(--accent); padding:4px 6px; margin-bottom:8px; cursor:pointer; border-radius:6px; }
pre { color:var(--accent); font-size:12px; line-height:1.2; text-align:center; height:80px; }
.error { color: #ff5252; padding: 8px; text-align: center; }
</style>
</head>
<body>
<header>
  <div>SpoTUI</div>
  <div>
    <button data-tab="dash" class="active">dashboard</button>
    <button data-tab="genres">top genres</button>
    <button id="login">login</button>
  </div>
</header>
<main>
<section id="dash" class="view active">
  <div class="panel"><h2>‚ù§ liked</h2><ul id="liked"></ul></div>
  <div class="panel">
    <h2>üéß top tracks</h2>
    <select id="topTracksRange">
      <option value="short_term">Last 4 weeks</option>
      <option value="medium_term">Last 6 months</option>
      <option value="long_term">All time</option>
    </select>
    <ul id="topTracks"></ul>
  </div>
  <div class="panel">
    <h2>üé§ top artists</h2>
    <select id="topArtistsRange">
      <option value="short_term">Last 4 weeks</option>
      <option value="medium_term">Last 6 months</option>
      <option value="long_term">All time</option>
    </select>
    <ul id="topArtists"></ul>
  </div>
  <div class="panel"><h2>‚è± minutes ‚âà</h2><div id="minutes"></div></div>
</section>
<section id="genres" class="view">
  <div class="panel" style="grid-column:1/-1">
    <h2>üéµ Top Genres</h2>
    <pre id="ascii"></pre>
    <ul id="topGenres"></ul>
  </div>
</section>
</main>
<script>
const CLIENT_ID = "40274723ddd145d08253f59ccb201ef7";
const REDIRECT_URI = "https://dyedblackhair.github.io/SpoTUI/".trim();
const SCOPES = ["user-library-read","user-top-read","user-read-recently-played"];
let loginBtn;

function randomString(len=64){return crypto.getRandomValues(new Uint8Array(len)).reduce((s,b)=>s+('0'+b.toString(16)).slice(-2),'');}
function base64url(a){return btoa(String.fromCharCode(...new Uint8Array(a))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');}
async function sha256(t){return crypto.subtle.digest('SHA-256',new TextEncoder().encode(t));}

async function login(){
  const verifier=randomString();
  const challenge=base64url(await sha256(verifier));
  localStorage.setItem('verifier',verifier);
  const p=new URLSearchParams({
    response_type:'code',
    client_id:CLIENT_ID,
    redirect_uri:REDIRECT_URI,
    scope:SCOPES.join(' '),
    code_challenge_method:'S256',
    code_challenge:challenge
  });
  location.href='https://accounts.spotify.com/authorize?'+p;
}

async function exchange(code){
  const body=new URLSearchParams({
    grant_type:'authorization_code',
    code,
    redirect_uri:REDIRECT_URI,
    client_id:CLIENT_ID,
    code_verifier:localStorage.getItem('verifier')
  });
  const r=await fetch('https://accounts.spotify.com/api/token',{
    method:'POST',
    headers:{'Content-Type':'application/x-www-form-urlencoded'},
    body
  });
  if (!r.ok) {
    const err = await r.json().catch(() => ({error: 'Token exchange failed'}));
    throw new Error(err.error_description || err.error || 'Invalid token response');
  }
  return r.json();
}

async function api(url){
  const token = localStorage.getItem('token');
  if (!token) throw new Error('No authentication token');
  
  const response = await fetch(url.trim(), {
    headers: {'Authorization': 'Bearer ' + token}
  });
  
  if (response.status === 401) {
    localStorage.removeItem('token');
    localStorage.removeItem('verifier');
    alert('Session expired. Please log in again.');
    location.reload();
    return;
  }
  
  if (!response.ok) {
    const err = await response.json().catch(() => ({}));
    throw new Error(`API ${response.status}: ${err.error?.message || response.statusText}`);
  }
  
  return response.json();
}
async function loadLiked(){
  try {
    const d = await api('https://api.spotify.com/v1/me/tracks?limit=15');
    if (!d?.items) throw new Error('Invalid response structure');
    
    liked.innerHTML = '';
    d.items.slice(0,15).forEach(x => {
      if (!x?.track) return;
      const img = x.track.album?.images?.[1]?.url || x.track.album?.images?.[0]?.url || '';
      const artists = x.track.artists?.map(a => a.name).join(', ') || 'Unknown Artist';
      liked.innerHTML += `
        <li class='card'>
          <img src="${img}" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2250%22 height=%2250%22><rect width=%22100%22 height=%22100%22 fill=%22%232a2339%22/></svg>'">
          <div>
            <div class='title'>${escapeHtml(x.track.name)}</div>
            <div class='subtitle'>${escapeHtml(artists)}</div>
          </div>
        </li>`;
    });
  } catch (e) {
    console.error('Liked tracks error:', e);
    liked.innerHTML = `<li class="error">‚ù§ Failed to load: ${escapeHtml(e.message)}</li>`;
  }
}

async function loadTop(){
  try {
    const tracksRange = document.getElementById('topTracksRange').value;
    const artistsRange = document.getElementById('topArtistsRange').value;
    
    const [t, a] = await Promise.all([
      api(`https://api.spotify.com/v1/me/top/tracks?limit=5&time_range=${tracksRange}`),
      api(`https://api.spotify.com/v1/me/top/artists?limit=5&time_range=${artistsRange}`)
    ]);
    
    if (t?.items) {
      topTracks.innerHTML = '';
      t.items.forEach((x,i) => {
        if (!x) return;
        const img = x.album?.images?.[1]?.url || x.album?.images?.[0]?.url || '';
        topTracks.innerHTML += `
          <li class='card'>
            <img src="${img}" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2250%22 height=%2250%22><rect width=%22100%22 height=%22100%22 fill=%22%232a2339%22/></svg>'">
            <div class='title'>${i+1}. ${escapeHtml(x.name)}</div>
          </li>`;
      });
    } else {
      topTracks.innerHTML = '<li class="error">No tracks found</li>';
    }
    
    if (a?.items) {
      topArtists.innerHTML = '';
      a.items.forEach((x,i) => {
        if (!x) return;
        const img = x.images?.[1]?.url || x.images?.[0]?.url || '';
        topArtists.innerHTML += `
          <li class='card'>
            <img src="${img}" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2250%22 height=%2250%22><rect width=%22100%22 height=%22100%22 fill=%22%232a2339%22/></svg>'">
            <div class='title'>${i+1}. ${escapeHtml(x.name)}</div>
          </li>`;
      });
    } else {
      topArtists.innerHTML = '<li class="error">No artists found</li>';
    }
  } catch (e) {
    console.error('Top content error:', e);
    topTracks.innerHTML = `<li class="error">üéß ${escapeHtml(e.message)}</li>`;
    topArtists.innerHTML = `<li class="error">üé§ ${escapeHtml(e.message)}</li>`;
  }
}

async function calcMinutes(){
  try {
    const shortTerm = await api('https://api.spotify.com/v1/me/player/recently-played?limit=50');
    if (!shortTerm?.items) throw new Error('No play history');
    const total = shortTerm.items.reduce((s,i) => s + (i.track?.duration_ms || 0), 0);
    minutes.textContent = `${Math.round(total/60000)} min (last 50 tracks)`;
  } catch (e) {
    console.error('Minutes calc error:', e);
    minutes.textContent = '‚è± Unavailable';
  }
}

async function loadGenres(){
  asciiAnimation();
  try {
    const a = await api('https://api.spotify.com/v1/me/top/artists?limit=20&time_range=medium_term');
    if (!a?.items) throw new Error('No artist data');
    
    const genreCount = {};
    a.items.forEach(artist => {
      if (artist.genres) artist.genres.forEach(g => {
        genreCount[g] = (genreCount[g] || 0) + 1;
      });
    });
    
    const sortedGenres = Object.entries(genreCount)
      .sort((a,b) => b[1] - a[1])
      .slice(0, 10);
    
    topGenres.innerHTML = sortedGenres.map(([g,c]) => `
      <li class='genre-card'>
        <span class='name'>${escapeHtml(g)}</span>
        <div class='bar' style='width:${Math.min(100, c * 10)}%'></div>
      </li>`).join('');
  } catch (e) {
    console.error('Genres error:', e);
    topGenres.innerHTML = `<li class="error">üéµ ${escapeHtml(e.message)}</li>`;
  }
}

function asciiAnimation(){
  const rows = 4, cols = 20;
  setInterval(() => {
    let str = '';
    for(let r=0; r<rows; r++) {
      for(let c=0; c<cols; c++) {
        str += Math.random() > 0.7 ? '‚ñà' : ' ';
      }
      str += '\n';
    }
    ascii.textContent = str;
  }, 400);
}

function escapeHtml(unsafe) {
  if (typeof unsafe !== 'string') return '';
  return unsafe
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

document.addEventListener('DOMContentLoaded', () => {
  loginBtn = document.getElementById('login');
  loginBtn.onclick = login;
  
  document.querySelectorAll('button[data-tab]').forEach(b => {
    b.onclick = () => {
      document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
      document.getElementById(b.dataset.tab).classList.add('active');
      document.querySelectorAll('button[data-tab]').forEach(x => x.classList.remove('active'));
      b.classList.add('active');
    }
  });
  
  document.getElementById('topTracksRange').onchange = loadTop;
  document.getElementById('topArtistsRange').onchange = loadTop;
  handleRedirect();
});

async function handleRedirect(){
  const params = new URLSearchParams(window.location.search);
  const code = params.get('code');
  const token = localStorage.getItem('token');
  if (code || token) {
    history.replaceState({}, '', window.location.pathname);
  }
  
  if (code) {
    try {
      const tokenResp = await exchange(code);
      if (tokenResp.access_token) {
        localStorage.setItem('token', tokenResp.access_token);
        localStorage.removeItem('verifier');
        await init();
      } else {
        throw new Error('No access token received');
      }
    } catch(e) {
      console.error('Auth error:', e);
      alert(`Login failed: ${e.message}. Please try again.`);
      localStorage.removeItem('verifier');
      loginBtn.style.display = 'block';
    }
  } else if (token) {
    try {
      await init();
    } catch (e) {
      console.error('Init error:', e);
      if (e.message.includes('401')) return;
      alert('Session error. Please log in again.');
      localStorage.removeItem('token');
      loginBtn.style.display = 'block';
    }
  } else {
    loginBtn.style.display = 'block';
  }
}

async function init(){
  loginBtn.style.display = 'none';
  await Promise.allSettled([
    loadLiked(),
    loadTop(),
    calcMinutes(),
    loadGenres()
  ]);
}
</script>
</body>
</html>
